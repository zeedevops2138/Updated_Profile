<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Profile</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- LOGIN SECTION -->
  <div class="container" id="login-container">
    <h1>Enter Your Email</h1>
    <input type="email" id="user-email" placeholder="you@example.com" />
    <button class="button" id="load-profile-btn">Load Profile</button>
    <p class="message" id="login-message"></p>
  </div>

  <!-- PROFILE DISPLAY SECTION -->
  <div class="container" id="container" style="display:none;">
    <h1>User Profile</h1>
    <img id="profile-img" class="circle-image" src="" alt="user-profile" />
    <div class="profile-row"><strong>Name:</strong> <span id="name">Unknown</span></div><hr />
    <div class="profile-row"><strong>Email:</strong> <span id="email">you@example.com</span></div><hr />
    <div class="profile-row"><strong>Interests:</strong> <span id="interests">N/A</span></div><hr />
    <button class="button" id="edit-profile-btn">Edit Profile</button>
    <p class="message success" id="status"></p>
  </div>

  <!-- EDIT PROFILE SECTION -->
  <div class="container" id="container-edit" style="display:none;">
    <h1>Edit Profile</h1>

    <div class="file-upload-wrapper">
      <input type="file" id="input-image" accept="image/*" />
      <div class="file-upload-preview" id="file-upload-preview">
        <span id="upload-icon">ðŸ“·</span>
      </div>
    </div>

    <label>
      Name:<br />
      <input type="text" id="input-name" placeholder="Your name" />
    </label><br />
    <label>
      Email:<br />
      <input type="email" id="input-email" disabled />
    </label><br />
    <label>
      Interests:<br />
      <input type="text" id="input-interests" placeholder="Your interests" />
    </label><br />
    <button class="button" id="update-profile-btn">Update Profile</button>
    <p class="message" id="edit-message"></p>
  </div>

  <script>
    const loginContainer = document.getElementById('login-container');
    const profileContainer = document.getElementById('container');
    const editContainer = document.getElementById('container-edit');

    const loginMessage = document.getElementById('login-message');
    const statusMessage = document.getElementById('status');
    const editMessage = document.getElementById('edit-message');

    let currentEmail = null;
    let currentImageUrl = null;

    document.getElementById('load-profile-btn').addEventListener('click', loadUserProfile);
    document.getElementById('edit-profile-btn').addEventListener('click', editProfile);
    document.getElementById('update-profile-btn').addEventListener('click', handleUpdateProfileRequest);
    document.getElementById('input-image').addEventListener('change', previewImage);

    function showMessage(element, message, type = 'error') {
      element.textContent = message;
      element.className = `message ${type}`;
      if (message) {
        setTimeout(() => {
          element.textContent = '';
          element.className = 'message';
        }, 4000);
      }
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    async function loadUserProfile() {
      showMessage(loginMessage, '');
      const emailInput = document.getElementById('user-email').value.trim();
      if (!emailInput) {
        showMessage(loginMessage, "Please enter your email.");
        return;
      }
      if (!validateEmail(emailInput)) {
        showMessage(loginMessage, "Please enter a valid email.");
        return;
      }
      currentEmail = emailInput;

      try {
        const response = await fetch(`/get-profile?email=${encodeURIComponent(currentEmail)}`);
        const data = await response.json();

        loginContainer.style.display = 'none';
        statusMessage.textContent = '';
        editMessage.textContent = '';

        if (data.newUser) {
          showMessage(editMessage, "New user detected. Please complete your profile.", 'info');
          document.getElementById('input-name').value = "";
          document.getElementById('input-email').value = currentEmail;
          document.getElementById('input-interests').value = "";
          document.getElementById('file-upload-preview').innerHTML = '<span id="upload-icon">ðŸ“·</span>';
          editContainer.style.display = 'block';
        } else {
          const user = data.user;
          document.getElementById('name').textContent = user.name || 'Unknown';
          document.getElementById('email').textContent = currentEmail;
          document.getElementById('interests').textContent = user.interests || 'N/A';
          currentImageUrl = user.imageUrl;
          document.getElementById('profile-img').src = currentImageUrl || '/profile-picture';
          profileContainer.style.display = 'block';
        }
      } catch (err) {
        showMessage(loginMessage, 'Failed to load profile. Please try again.');
        loginContainer.style.display = 'block';
      }
    }

    function editProfile() {
      showMessage(editMessage, '');
      document.getElementById('input-name').value = document.getElementById('name').textContent;
      document.getElementById('input-email').value = document.getElementById('email').textContent;
      document.getElementById('input-interests').value = document.getElementById('interests').textContent;

      const previewContainer = document.getElementById('file-upload-preview');
      if (currentImageUrl) {
        previewContainer.innerHTML = `<img src="${currentImageUrl}" alt="Preview" />`;
      } else {
        previewContainer.innerHTML = '<span id="upload-icon">ðŸ“·</span>';
      }

      profileContainer.style.display = 'none';
      editContainer.style.display = 'block';
      statusMessage.textContent = '';
    }

    async function handleUpdateProfileRequest() {
      showMessage(editMessage, '');
      const name = document.getElementById('input-name').value.trim();
      const interests = document.getElementById('input-interests').value.trim();

      if (!name) {
        showMessage(editMessage, "Name cannot be empty.");
        return;
      }
      if (!interests) {
        showMessage(editMessage, "Interests cannot be empty.");
        return;
      }

      const formData = new FormData();
      formData.append('user', JSON.stringify({
        email: currentEmail,
        name,
        interests,
      }));

      const fileInput = document.getElementById('input-image');
      if (fileInput.files[0]) {
        formData.append('profileImage', fileInput.files[0]);
      }

      try {
        const response = await fetch('/update-profile', { method: "POST", body: formData });
        if (!response.ok) throw new Error('Failed to update profile.');
        const jsonResponse = await response.json();

        document.getElementById('name').textContent = jsonResponse.name;
        document.getElementById('email').textContent = jsonResponse.email;
        document.getElementById('interests').textContent = jsonResponse.interests;
        document.getElementById('profile-img').src = jsonResponse.imageUrl || '/profile-picture';
        currentImageUrl = jsonResponse.imageUrl;

        editContainer.style.display = 'none';
        profileContainer.style.display = 'block';
        showMessage(statusMessage, "Profile updated successfully!", 'success');
      } catch (err) {
        showMessage(editMessage, "Failed to update profile. Try again.");
      }
    }

    function previewImage() {
      const file = this.files[0];
      const previewContainer = document.getElementById('file-upload-preview');
      const uploadIcon = document.getElementById('upload-icon');

      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          if (uploadIcon) uploadIcon.style.display = 'none';
          previewContainer.innerHTML = `<img src="${e.target.result}" alt="Preview" />`;
        };
        reader.readAsDataURL(file);
      }
    }
  </script>

</body>
</html>
